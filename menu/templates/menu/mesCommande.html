{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Mes commandes | Restaurant Authentique{% endblock title %}
{% block content %}

<section class="relative bg-slate-900 pt-20 pb-12 overflow-hidden">

<div class="absolute inset-0">
        <img src="{% static 'menu/img/commande.jpg' %}" class="w-full h-full object-cover blur-sm scale-105">
        <div class="absolute inset-0 bg-gradient-to-b from-gray-900/60 via-gray-900/80 to-gray-900"></div>
    </div>
    <div class="relative z-10 max-w-7xl mx-auto px-4">
        <div class="flex items-center justify-between flex-wrap gap-6">
            <div>
                <nav class="flex mb-4 text-sm text-orange-400 font-medium">
                    <a href="{% url 'home' %}" class="hover:underline">Accueil</a>
                    <span class="mx-2 text-gray-500">/</span>
                    <span class="text-gray-300">Historique</span>
                </nav>
                <h1 class="text-4xl font-black text-white mb-2 uppercase tracking-tighter">
                    Mes <span class="text-orange-500">Commandes</span>
                </h1>
                <p class="text-gray-400 text-lg border-l-4 border-orange-500 pl-4">Suivi en temps réel de votre activité.</p>
            </div>

            {% if stats.total > 0 %}
            <div class="grid grid-cols-3 gap-1 bg-white/5 p-1 rounded-xl">
                <div class="bg-slate-800 px-6 py-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-white">{{ stats.total }}</div>
                    <div class="text-xs uppercase tracking-widest text-gray-400 font-bold">Total</div>
                </div>
                <div class="bg-slate-800 px-6 py-4 rounded-lg text-center border-x border-slate-700">
                    <div class="text-3xl font-bold text-green-500">{{ stats.completed|default:0 }}</div>
                    <div class="text-xs uppercase tracking-widest text-gray-400 font-bold">Livrées</div>
                </div>
                <div class="bg-slate-800 px-6 py-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-orange-500">{{ stats.total_spent|intcomma|default:"0" }}</div>
                    <div class="text-xs uppercase tracking-widest text-gray-400 font-bold">XAF</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 -mt-6">

    {% if messages %}
        {% for message in messages %}
        <div class="mb-6 p-4 rounded-none border-l-8 {% if message.tags == 'success' %}bg-green-100 border-green-600 text-green-900{% elif message.tags == 'error' %}bg-red-100 border-red-600 text-red-900{% else %}bg-blue-100 border-blue-600 text-blue-900{% endif %} font-bold shadow-sm">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    {% if commandes %}

    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-6 mb-8">
        <form method="get" class="flex flex-col xl:flex-row gap-6 items-center">
            <div class="relative w-full xl:flex-1">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </span>
                <input type="text" name="search" value="{{ search_query }}"
                       placeholder="Rechercher une commande..."
                       class="w-full pl-10 pr-4 py-3 bg-gray-50 border-none rounded-lg focus:ring-2 focus:ring-orange-500 font-medium">
            </div>

            <div class="flex gap-2 p-1 bg-gray-100 rounded-xl overflow-x-auto w-full xl:w-auto">
                <button type="submit" name="status" value="all" class="flex-1 px-5 py-2 text-sm font-bold rounded-lg whitespace-nowrap {% if current_filter == 'all' %}bg-white shadow-sm text-orange-600{% else %}text-gray-500 hover:text-gray-800{% endif %}">
                    Toutes
                </button>
                <button type="submit" name="status" value="pending" class="flex-1 px-5 py-2 text-sm font-bold rounded-lg whitespace-nowrap {% if current_filter == 'pending' %}bg-yellow-400 text-yellow-900{% else %}text-gray-500 hover:text-gray-800{% endif %}">
                    En attente
                </button>
                <button type="submit" name="status" value="completed" class="flex-1 px-5 py-2 text-sm font-bold rounded-lg whitespace-nowrap {% if current_filter == 'completed' %}bg-green-500 text-white{% else %}text-gray-500 hover:text-gray-800{% endif %}">
                    Livrées
                </button>
                <button type="submit" name="status" value="failed" class="flex-1 px-5 py-2 text-sm font-bold rounded-lg whitespace-nowrap {% if current_filter == 'failed' %}bg-red-600 text-white{% else %}text-gray-500 hover:text-gray-800{% endif %}">
                    Annulées
                </button>
            </div>
        </form>
    </div>

    <div class="space-y-6">
        {% for commande in commandes %}
        <div class="group bg-white rounded-xl border border-gray-200 hover:border-orange-500 transition-all duration-200 overflow-hidden shadow-sm">

            <div class="flex flex-col md:flex-row">
                <div class="md:w-48 h-48 md:h-auto relative overflow-hidden bg-gray-100">
                    {% if commande.plats.image %}
<img src="{% static 'image/' %}{{ commande.plats.image.name|cut:'image/' }}"
     alt="{{ commande.plats.nom }}"
     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center text-gray-300">
                            <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/></svg>
                        </div>
                    {% endif %}
                    <div class="absolute top-2 left-2">
                        <span class="px-3 py-1 text-[10px] font-black uppercase tracking-widest bg-white/90 backdrop-blur shadow-sm rounded">
                            #{{ commande.pk }}
                        </span>
                    </div>
                </div>

                <div class="flex-1 p-6">
                    <div class="flex flex-col lg:flex-row justify-between gap-4">
                        <div class="space-y-2">
                            <div class="flex items-center gap-3">
                                {% if commande.status == 'pending' %}
                                    <span class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></span>
                                    <span class="text-xs font-black uppercase text-yellow-700">Préparation en cours</span>
                                {% elif commande.status == 'completed' %}
                                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                    <span class="text-xs font-black uppercase text-green-600">Livrée avec succès</span>
                                {% elif commande.status == 'failed' %}
                                    <span class="w-3 h-3 rounded-full bg-red-600"></span>
                                    <span class="text-xs font-black uppercase text-red-600">Commande annulée</span>
                                {% endif %}
                                <span class="text-gray-300">|</span>
                                <span class="text-xs font-medium text-gray-500">{{ commande.created_at|date:"d F Y" }} à {{ commande.created_at|date:"H:i" }}</span>
                            </div>

                            <h3 class="text-2xl font-bold text-gray-900 group-hover:text-orange-600 transition-colors">{{ commande.plats.nom }}</h3>
                            <p class="text-gray-500 text-sm max-w-xl line-clamp-1">{{ commande.plats.description }}</p>
                        </div>

                        <div class="lg:text-right flex lg:flex-col justify-between items-end">
                            <div>
                                <span class="text-xs text-gray-400 font-bold uppercase block">Montant</span>
                                <span class="text-2xl font-black text-slate-900">{{ commande.montant|intcomma }} <small class="text-sm font-normal text-gray-500">XAF</small></span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 flex flex-wrap items-center justify-between gap-4 pt-6 border-t border-gray-50">
                        <div class="flex gap-3">
                            {% if commande.status == 'completed' %}
                                <form method="post" action="{% url 'reorder' commande.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="px-6 py-2.5 bg-orange-600 hover:bg-orange-700 text-white text-xs font-bold uppercase tracking-widest rounded-lg transition-all active:scale-95">
                                        Commander à nouveau
                                    </button>
                                </form>
                            {% endif %}

                            {% if commande.status == 'pending' %}
                                <form method="post" action="{% url 'cancel_commande' commande.pk %}" onsubmit="return confirm('Annuler cette commande ?');">
                                    {% csrf_token %}
                                    <button type="submit" class="px-6 py-2.5 bg-white border-2 border-red-100 hover:border-red-600 text-red-600 text-xs font-bold uppercase tracking-widest rounded-lg transition-all">
                                        Annuler
                                    </button>
                                </form>
                            {% endif %}

                            <button onclick="showOrderDetails({{ commande.pk }})" class="px-6 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold uppercase tracking-widest rounded-lg transition-all">
                                Détails
                            </button>
                        </div>

                        {% if commande.status == 'pending' %}
                        <div class="flex-1 max-w-[200px]">
                            <div class="flex justify-between mb-1">
                                <span class="text-[10px] font-bold text-orange-600 uppercase">Cuisine...</span>
                            </div>
                            <div class="w-full bg-gray-100 h-1.5 rounded-full">
                                <div class="bg-orange-500 h-1.5 rounded-full" style="width: 65%"></div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if paginator.num_pages > 1 %}
    <div class="mt-12 flex justify-center">
        <nav class="flex items-center gap-2">
            {% if commandes.has_previous %}
                <a href="?page={{ commandes.previous_page_number }}" class="p-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </a>
            {% endif %}

            <div class="bg-slate-900 text-white px-6 py-2 rounded-lg font-bold text-sm">
                {{ commandes.number }} / {{ paginator.num_pages }}
            </div>

            {% if commandes.has_next %}
                <a href="?page={{ commandes.next_page_number }}" class="p-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}

    {% else %}
    <div class="text-center py-20 bg-white rounded-3xl border-2 border-dashed border-gray-100">
        <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 118 0m-4 15V9m-4 10a2 2 0 100-4 2 2 0 000 4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-900">Aucun historique</h3>
        <p class="text-gray-400 mt-2 mb-8 font-medium">Il semble que vous n'ayez pas encore passé de commande.</p>
        <a href="{% url 'menu' %}" class="inline-flex items-center px-8 py-3 bg-orange-600 text-white font-black uppercase tracking-widest text-sm rounded-none hover:bg-orange-700 transition-all">
            Commander maintenant
        </a>
    </div>
    {% endif %}

</main>

<div id="orderModal" class="hidden fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-none max-w-xl w-full shadow-2xl overflow-hidden border-t-8 border-orange-600">
        <div class="p-8">
            <div id="orderModalContent">
                </div>
            <div class="mt-8 pt-6 border-t border-gray-100">
                <button onclick="closeOrderModal()" class="w-full py-4 bg-slate-900 text-white font-bold uppercase tracking-widest hover:bg-slate-800 transition-colors">
                    Fermer la fenêtre
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Le JavaScript reste identique pour préserver vos fonctionnalités,
// j'ai juste mis à jour le template HTML généré pour correspondre au nouveau design.
function showOrderDetails(commandeId) {
    const modal = document.getElementById('orderModal');
    const content = document.getElementById('orderModalContent');

    modal.classList.remove('hidden');
    content.innerHTML = '<div class="text-center py-12"><div class="w-10 h-10 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto"></div></div>';

    fetch(`/commande/${commandeId}/details/`)
        .then(response => response.json())
        .then(data => {
            const statusLabels = {
                'pending': 'En attente',
                'completed': 'Livrée',
                'failed': 'Annulée'
            };

            content.innerHTML = `
                <div class="space-y-4">
                    <span class="text-orange-600 font-black uppercase tracking-widest text-xs">Détails Commande</span>
                    <h4 class="text-3xl font-black text-slate-900">ID #${data.id}</h4>
                    <p class="text-gray-500 font-medium">${data.created_at}</p>

                    <div class="py-6 border-y border-gray-100 my-6">
                        <p class="text-xs uppercase text-gray-400 font-bold mb-2">Plat choisi</p>
                        <p class="text-xl font-bold text-slate-800">${data.plat.nom}</p>
                        <p class="text-gray-600 mt-1">${data.plat.description}</p>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-slate-900 font-black text-3xl">${data.montant.toLocaleString()} <small class="text-sm">XAF</small></span>
                        <span class="px-4 py-1 bg-slate-100 text-slate-900 font-bold uppercase text-[10px] rounded">${statusLabels[data.status]}</span>
                    </div>
                </div>
            `;
        })
        .catch(() => {
            content.innerHTML = '<p class="text-red-500 font-bold">Erreur de chargement.</p>';
        });
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.add('hidden');
}
</script>

{% endblock content %}